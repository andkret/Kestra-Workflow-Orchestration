# Create Pub/sub topic

gcloud pubsub topics create file-upload-events

# Create a subscription

gcloud pubsub subscriptions create file-upload-sub \
  --topic=file-upload-events

# Set Pub/Sub admin for service Admin

gcloud projects add-iam-policy-binding YOUR_PROJECT \
  --member="serviceAccount:KESRTA_SA@YOUR_PROJECT.iam.gserviceaccount.com" \
  --role="roles/pubsub.subscriber"

or just go and give the user pub/sub admin rights

# Configure GCS Bucket -> Pub/Sub notifications

gsutil notification create -f json -t file-upload-events gs://lde-my-kestra-workspace

# Enable the Pub/Sub API
Go to APIs & Services in the console

```
id: event_file_ingest
namespace: gcp.yellowcab

variables:
  project: "kestra-workspace-ak-lde-2025"
  dataset: "YellowCab"

triggers:

  - id: gcs_event_trigger
    type: io.kestra.plugin.gcp.pubsub.RealtimeTrigger
    projectId: "kestra-workspace-ak-lde-2025"
    topic: "file-upload-events"
    subscription: "file-upload-sub"
    serviceAccount: "{{ secret('GCP_SERVICE_ACCOUNT') }}"
    maxRecords: 1

tasks:

  - id: log_event
    type: io.kestra.plugin.core.debug.Return
    format: |
      Received Event:
      Bucket: {{ trigger.attributes.bucketId }}
      File:   {{ trigger.attributes.objectId }}

  - id: load_raw
    type: io.kestra.plugin.gcp.bigquery.LoadFromGcs
    serviceAccount: "{{ secret('GCP_SERVICE_ACCOUNT') }}"
    from:
      - "gs://{{ trigger.attributes.bucketId }}/{{ trigger.attributes.objectId }}"
    destinationTable: "{{ vars.project }}.{{ vars.dataset }}.pub_sub_raw"
    format: CSV
    autodetect: true
    csvOptions:
      skipLeadingRows: 1
    writeDisposition: WRITE_APPEND

errors:
  - id: on_error
    type: io.kestra.plugin.core.debug.Return
    format: |
      ERROR during RAW ingest:
      Bucket: {{ trigger.attributes.bucketId }}
      File:   {{ trigger.attributes.objectId }}
```