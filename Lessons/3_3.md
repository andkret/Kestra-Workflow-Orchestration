## Create a widely parallel task with subtask

### Main task:

```
id: yellow_cab_main
namespace: gcp.yellowcab

variables:
  bucket: "lde-my-kestra-workspace"

tasks:

  # ---------------------------------------------------------
  # 1. LIST INPUT FILES
  # ---------------------------------------------------------
  - id: list_files
    type: io.kestra.plugin.gcp.gcs.List
    from: "gs://{{ vars.bucket }}/yellow-cab/"
    serviceAccount: "{{ secret('GCP_SERVICE_ACCOUNT') }}"


  # ---------------------------------------------------------
  # 2. PARALLEL GCS -> BIGQUERY RAW INGESTION
  # ---------------------------------------------------------
  - id: foreach_file
    type: io.kestra.plugin.core.flow.ForEach
    values: "{{ outputs.list_files.blobs }}"
    concurrencyLimit: 5
    tasks:
      - id: load_raw
        type: io.kestra.plugin.gcp.bigquery.LoadFromGcs
        serviceAccount: "{{ secret('GCP_SERVICE_ACCOUNT') }}"
        from:
          - "{{ taskrun.value | jq('.uri') | first }}"
        destinationTable: "kestra-workspace-ak-lde-2025.YellowCab.raw_trips"
        format: PARQUET
        location: "EU"
        writeDisposition: WRITE_APPEND
        runIf: "{{ taskrun.value | jq('.size') | first > 0 }}"


  # ---------------------------------------------------------
  # 3. TRIGGER SUBFLOW (BigQuery transformations)
  # ---------------------------------------------------------
  - id: process_raw_data
    type: io.kestra.plugin.core.flow.Subflow
    namespace: gcp.yellowcab
    flowId: yellow_cab_bq_processing
    wait: true


  # ---------------------------------------------------------
  # 4a. COPY EACH FILE TO ARCHIVE (PER-FILE) 
  # ---------------------------------------------------------
  - id: foreach_copy
    type: io.kestra.plugin.core.flow.ForEach
    values: "{{ outputs.list_files.blobs }}"
    concurrencyLimit: 10
    tasks:
      - id: debug_blobs
        type: io.kestra.plugin.core.debug.Return
        format: |
          URI: {{ taskrun.value | jq('.uri') | first }}
          NAME: {{ taskrun.value | jq('.name') | first }}
          SIZE: {{ taskrun.value | jq('.size') | first }}
            
      - id: copy_to_archive
        type: io.kestra.plugin.gcp.gcs.Copy
        serviceAccount: "{{ secret('GCP_SERVICE_ACCOUNT') }}"
        from: "{{ taskrun.value | jq('.uri') | first }}"
        to: "gs://{{ vars.bucket }}/yellow-cab-archive/{{ taskrun.value | jq('.name') | first | split(\"/\") | last }}"
        runIf: "{{ taskrun.value | jq('.size') | first > 0 }}"

  # ðŸ”¥ BARRIER â€” IMPORTANT!?
  - id: wait_for_copy
    type: io.kestra.plugin.core.debug.Return
    format: "Copy completed"

# ---------------------------------------------------------
  # 4b. DELETE EACH FILE (PER-FILE)
  # ---------------------------------------------------------
  - id: foreach_delete
    type: io.kestra.plugin.core.flow.ForEach
    values: "{{ outputs.list_files.blobs }}"
    concurrencyLimit: 10
    tasks:
      - id: delete_file
        type: io.kestra.plugin.gcp.gcs.Delete
        serviceAccount: "{{ secret('GCP_SERVICE_ACCOUNT') }}"
        uri: "{{ taskrun.value | jq('.uri') | first }}"
        runIf: "{{ taskrun.value | jq('.size') | first > 0 }}"
```

### Subtask

```
id: yellow_cab_bq_processing
namespace: gcp.yellowcab

variables:
  bucket: "lde-my-kestra-workspace"

tasks:

  # ---------------------------------------------------------
  # 0) LOAD TAXI ZONE LOOKUP FROM GCS INTO BIGQUERY
  # ---------------------------------------------------------
  - id: load_taxi_zones
    type: io.kestra.plugin.gcp.bigquery.LoadFromGcs
    serviceAccount: "{{ secret('GCP_SERVICE_ACCOUNT') }}"
    from:
      - "gs://{{ vars.bucket }}/taxi_zone_lookup.csv"
    destinationTable: "kestra-workspace-ak-lde-2025.YellowCab.taxi_zones"
    format: CSV
    csvOptions:
      skipLeadingRows: 1
    autodetect: true
    writeDisposition: WRITE_TRUNCATE
    location: "EU"


  # ---------------------------------------------------------
  # 1) ENRICH RAW TRIPS WITH ZONE LOOKUP (JOIN ON PULocationID)
  # ---------------------------------------------------------
  - id: zone_classification
    type: io.kestra.plugin.gcp.bigquery.Query
    serviceAccount: "{{ secret('GCP_SERVICE_ACCOUNT') }}"
    location: "EU"
    sql: |
      CREATE OR REPLACE TABLE
        `kestra-workspace-ak-lde-2025.YellowCab.trips_with_zone` AS
      SELECT
        t.*,
        z.Borough        AS pu_borough,
        z.Zone           AS pu_zone,
        z.service_zone   AS pu_service_zone
      FROM
        `kestra-workspace-ak-lde-2025.YellowCab.raw_trips` t
      LEFT JOIN
        `kestra-workspace-ak-lde-2025.YellowCab.taxi_zones` z
      ON
        t.PULocationID = z.LocationID;


  # ---------------------------------------------------------
  # 2) SPECIAL TRIP DETECTION (PARALLEL)
  # ---------------------------------------------------------
  - id: special_trips
    type: io.kestra.plugin.core.flow.Parallel
    tasks:

      # Suspiciously low fares
      - id: suspicious_trips
        type: io.kestra.plugin.gcp.bigquery.Query
        serviceAccount: "{{ secret('GCP_SERVICE_ACCOUNT') }}"
        location: "EU"
        sql: |
          CREATE OR REPLACE TABLE
            `kestra-workspace-ak-lde-2025.YellowCab.suspicious_trips` AS
          SELECT *
          FROM `kestra-workspace-ak-lde-2025.YellowCab.trips_with_zone`
          WHERE fare_amount < 3;

      # Very short trips
      - id: short_trips
        type: io.kestra.plugin.gcp.bigquery.Query
        serviceAccount: "{{ secret('GCP_SERVICE_ACCOUNT') }}"
        location: "EU"
        sql: |
          CREATE OR REPLACE TABLE
            `kestra-workspace-ak-lde-2025.YellowCab.short_trips` AS
          SELECT *
          FROM `kestra-workspace-ak-lde-2025.YellowCab.trips_with_zone`
          WHERE trip_distance < 0.5;

      # Ultra long trips
      - id: long_trips
        type: io.kestra.plugin.gcp.bigquery.Query
        serviceAccount: "{{ secret('GCP_SERVICE_ACCOUNT') }}"
        location: "EU"
        sql: |
          CREATE OR REPLACE TABLE
            `kestra-workspace-ak-lde-2025.YellowCab.long_trips` AS
          SELECT *
          FROM `kestra-workspace-ak-lde-2025.YellowCab.trips_with_zone`
          WHERE trip_distance > 40;

      # Invalid GPS / bad location
      - id: invalid_gps
        type: io.kestra.plugin.gcp.bigquery.Query
        serviceAccount: "{{ secret('GCP_SERVICE_ACCOUNT') }}"
        location: "EU"
        sql: |
          CREATE OR REPLACE TABLE
            `kestra-workspace-ak-lde-2025.YellowCab.invalid_gps` AS
          SELECT *
          FROM `kestra-workspace-ak-lde-2025.YellowCab.trips_with_zone`
          WHERE PULocationID IS NULL
             OR PULocationID = 0;


  # ---------------------------------------------------------
  # 3) AGGREGATIONS (PARALLEL)
  # ---------------------------------------------------------
  - id: aggregations
    type: io.kestra.plugin.core.flow.Parallel
    tasks:

      # Trips grouped by borough
      - id: trips_per_borough
        type: io.kestra.plugin.gcp.bigquery.Query
        serviceAccount: "{{ secret('GCP_SERVICE_ACCOUNT') }}"
        location: "EU"
        sql: |
          CREATE OR REPLACE TABLE
            `kestra-workspace-ak-lde-2025.YellowCab.trips_per_borough` AS
          SELECT pu_borough, COUNT(*) AS trips
          FROM `kestra-workspace-ak-lde-2025.YellowCab.trips_with_zone`
          GROUP BY pu_borough;

      # Average fare per borough
      - id: avg_fare_per_borough
        type: io.kestra.plugin.gcp.bigquery.Query
        serviceAccount: "{{ secret('GCP_SERVICE_ACCOUNT') }}"
        location: "EU"
        sql: |
          CREATE OR REPLACE TABLE
            `kestra-workspace-ak-lde-2025.YellowCab.avg_fare_per_borough` AS
          SELECT pu_borough, AVG(fare_amount) AS avg_fare
          FROM `kestra-workspace-ak-lde-2025.YellowCab.trips_with_zone`
          GROUP BY pu_borough;

      # Trips by hour of day
      - id: trips_by_hour
        type: io.kestra.plugin.gcp.bigquery.Query
        serviceAccount: "{{ secret('GCP_SERVICE_ACCOUNT') }}"
        location: "EU"
        sql: |
          CREATE OR REPLACE TABLE
            `kestra-workspace-ak-lde-2025.YellowCab.trips_by_hour` AS
          SELECT
            EXTRACT(HOUR FROM tpep_pickup_datetime) AS hour,
            COUNT(*) AS trips
          FROM `kestra-workspace-ak-lde-2025.YellowCab.trips_with_zone`
          GROUP BY hour;


  # ---------------------------------------------------------
  # 4) FINAL CURATED TABLE
  # ---------------------------------------------------------
  - id: curated_table
    type: io.kestra.plugin.gcp.bigquery.Query
    serviceAccount: "{{ secret('GCP_SERVICE_ACCOUNT') }}"
    location: "EU"
    sql: |
      CREATE OR REPLACE TABLE
        `kestra-workspace-ak-lde-2025.YellowCab.trips_cleaned` AS
      SELECT *
      FROM `kestra-workspace-ak-lde-2025.YellowCab.trips_with_zone`
      WHERE trip_distance > 0
        AND fare_amount > 0
        AND pu_borough IS NOT NULL;
```
