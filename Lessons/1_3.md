## Connect Kestra to GCP

### GCP Account & Project Setup

If you already have a GCP account and project skip ahead. If not, here's what you need:

1. Go to https://console.cloud.google.com/
1. Sign in with your Google account
1. Create a new project (e.g., "kestra-demo")

> [!NOTE]
> You need to provide a payment method in this step. 

> [!IMPORTANT]
> Be aware that queries against GCP can incur costs. Check twice before running queries. 

### Install GCP CLI MAC

If you have the GCP CLI already installed, you can skip this command.

On Mac:
```bash
curl https://sdk.cloud.google.com | bash

gcloud init
```

During `gcloud init`, it will:

- Ask you to log in with your Google account
- Ask you to select or create a project (use the actual name of the project - in our case 'kestra-demo').

### Install GCP CLI WSL2
```bash
sudo apt update && sudo apt install apt-transport-https ca-certificates gnupg

echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] http://packages.cloud.google.com/apt cloud-sdk main" \
  | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list

curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo tee /usr/share/keyrings/cloud.google.gpg > /dev/null

sudo apt update && sudo apt install google-cloud-sdk


### Enable required APIs

For this tutorial, we will use Google Storage and BigQuery. Therefore, we need to enable their APIs.

```bash
gcloud services enable storage.googleapis.com

gcloud services enable bigquery.googleapis.com
```

### Create a GCS Bucket

> [!NOTE]
> Replace 'com-mycompany-kestra-demo' with something unique (bucket names are global).

```bash
gsutil mb -l europe-west3 gs://com-mycompany-kestra-demo/
```

Verify if it was created, via:
```bash
gsutil ls
```

> [!NOTE]
> Bucket names must be globally unique across all of GCP, so a reverse domain identifier with dashes combined with the project name makes sense (e.g. `gs://com-mycompany-kestra-demo`).

### Create a BigQuery Dataset (for testing)

For testing, we'll need a dataset. Run these commands to create and verify them:

```bash
bq mk --dataset --location=europe-west3 kestra_test

bq ls
```

The second command should print out the file.

### Create a service account

A service account is like a robot user or machine identity in GCP. It's used when applications (like Kestra) need to access GCP resources automatically, without a human logging in.

These are the required commands you need to run.

1. Create the service account

```bash
gcloud iam service-accounts create kestra-sa --display-name="Kestra Service Account"
```
2. Get and store your project ID 
```bash
PROJECT_ID=$(gcloud config get-value project)
```
3. Grant it permissions for BigQuery 
```bash
gcloud projects add-iam-policy-binding $PROJECT_ID --member="serviceAccount:kestra-sa@${PROJECT_ID}.iam.gserviceaccount.com" --role="roles/bigquery.admin"
```
4. Grant it necessary permissions for Cloud Storage
```bash
gcloud projects add-iam-policy-binding $PROJECT_ID --member="serviceAccount:kestra-sa@${PROJECT_ID}.iam.gserviceaccount.com" --role="roles/storage.admin"
```

> [!IMPORTANT]
> For production, these permissions are maybe too broad. Consider not using the `bigquery.admin` and `storage.admin` role. 

### Generate and Download the JSON Key

These keys are now needed to perform uploads for the service account.

Run these commands:

1. Create and download the key
```bash
gcloud iam service-accounts keys create ~/kestra-gcp-key.json --iam-account=kestra-sa@${PROJECT_ID}.iam.gserviceaccount.com
```
2. Verify the file exists
```bash
ls -lh ~/kestra-gcp-key.json
```

### Create secret for Kestra deployment


### Use docker-compose.yml to start up Kestra



#### Create Your First Flow

Select the option to create your first flow (e.g. 'Create my first flow'). You can skip all tutorials or watch them, whatever you prefer.

Completing or skipping the tutorial will lead you to this screen:

![Kestra Flows](/images/kestra-flows.png)

Now paste this flow which will create a simple text file with some text in it with Python:

```yaml
id: test-gcs-connection
namespace: dev.testing

tasks:
  - id: create_and_upload
    type: io.kestra.plugin.scripts.python.Script
    outputFiles:
      - "hello.txt"
    script: |
      with open('hello.txt', 'w') as f:
          f.write('Hello from Kestra! GCP connection works! ðŸŽ‰')
  
  - id: upload_to_gcs
    type: io.kestra.plugin.gcp.gcs.Upload
    from: "{{ outputs.create_and_upload.outputFiles['hello.txt'] }}"
    to: "gs://com-mycompany-kestra-demo/test/hello.txt"
```
> [!IMPORTANT]
> Replace `com-mycompany-kestra-demo` with YOUR actual bucket name from earlier!

Click 'Save' and 'Execute'. 

After a successful run (indicated by green progress bars), run the following command (again replace with YOUR actual bucket name):

```bash
gsutil cat gs://com-mycompany-kestra-demo/test/hello.txt
```

This should output:
`Hello from Kestra! GCP connection works! ðŸŽ‰`