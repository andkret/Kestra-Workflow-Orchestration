## Synchronizing Code from GitHub

Kestra can automatically sync your code from Git repositories like GitHub, keeping your workflows and scripts version-controlled and up-to-date. This enables true GitOps workflows where Git becomes your single source of truth.

### Understanding Git Sync in Kestra
Kestra offers two main approaches for syncing code from Git repositories:

#### NamespaceSync - Project-Specific Code Sync

Syncs files from a single Git directory to a specific namespace.

- **Best for:** Team-specific code, isolated projects.
- **Use when:** You want simple, focused syncing for one team/project.
- **Git structure:** Flat directory structure (e.g., `data-processing/`).
- **Scope:** Files are only available within the target namespace.
- **Example:** Your data engineering team's Python ETL scripts in `dev.testing` namespace.
- **Authentication:** Uses Git credentials only.

**When to use:** You have a simple project where all code belongs to one team/namespace.

#### TenantSync - Multi-Namespace Code Distribution

Syncs files and flows from a structured Git repository to multiple namespaces simultaneously.

- **Best for:** Organization-wide code distribution, shared utilities.
- **Use when:** You need to distribute code across multiple namespaces from a single source.
- **Git structure:** Namespace-based directory structure (e.g., `<namespace>/files/`, `<namespace>/flows/`).
- **Scope:** Syncs to ALL namespaces found in your Git repository structure.
- **Example:** Shared validation libraries in `common/files/` â†’ `common` namespace, team-specific code in `dev.testing/files/` â†’ `dev.testing` namespace.
- **Authentication:** Requires both Git credentials AND Kestra API credentials.

**When to use:** You have multiple teams/namespaces and want centralized GitOps management of all code.

> [!IMPORTANT]
> **Key Difference:** NamespaceSync is simpler and syncs one directory to one namespace. TenantSync reads your entire repository structure and creates/updates files in multiple namespaces based on the folder names. It distributes files to their respective namespaces based on your Git folder structure.

ðŸ‘‰ More info about [TenantSync and NamespaceSync](https://kestra.io/docs/version-control-cicd/git#git-tenantsync-and-namespacesync).

### Prerequisites
Before starting, ensure you have:

- A GitHub account (free account is sufficient)
- Git installed on your machine
- Your Kestra instance running with port-forwarding active

### Step 1: Create a GitHub Repository

First, let's create a repository to hold our code.
1. Go to https://github.com and sign in
1. Click the + icon in the top right, then select "New repository"
1. Configure your repository:
    - Repository name: kestra-demo
    - Description: "Demo project for Kestra Git sync"
    - Visibility, .gitignore, and license as you want (for this demo, we won't add a license, use a private repo without a .gitignore file).
4. Click "Create repository"

Perfect! Here's the revised Step 2:

### Step 2: Set Up Your Repository Structure Locally
Now let's create the repository structure on your local machine and connect it to GitHub.
We'll create a structure that works for both NamespaceSync and TenantSync.

1. Create a new directory for the project and initialize Git:
```bash
mkdir kestra-git-demo
cd kestra-git-demo
git init
```
2. Create the folder structure:
```bash
# For NamespaceSync (simple structure)
mkdir -p data-processing

# For TenantSync (namespace-based structure)
mkdir -p dev.testing/files
mkdir -p common/files
```
3. Create the file `process_sales.py` in `data-processing` with the content:
```python
import pandas as pd

def process_sales_data():
    print("Running from GitHub-synced code!")
    
    data = {
        'product': ['Laptop', 'Mouse', 'Keyboard'],
        'quantity': [50, 200, 150],
        'price': [999.99, 29.99, 79.99]
    }
    df = pd.DataFrame(data)
    df['revenue'] = df['quantity'] * df['price']
    
    df.to_csv('sales_output.csv', index=False)
    
    total = df['revenue'].sum()
    print(f"âœ“ Total revenue: ${total:,.2f}")
    return total

if __name__ == "__main__":
    process_sales_data()
```
4. Create the file `process_orders.py` in `dev.testing/files/` with the content:
```python
import pandas as pd

def process_orders():
    print("Running from GitHub-synced code via TenantSync!")
    
    data = {
        'order_id': [1, 2, 3],
        'customer': ['Alice', 'Bob', 'Charlie'],
        'amount': [150.00, 200.50, 99.99]
    }
    df = pd.DataFrame(data)
    
    df.to_csv('orders_output.csv', index=False)
    
    total = df['amount'].sum()
    print(f"âœ“ Total orders: ${total:,.2f}")
    return total

if __name__ == "__main__":
    process_orders()
```
5. Create the file `validator.py` in `common/files` with the content:
```python
def validate_phone(phone):
    """Simple phone validator - shared utility"""
    digits = ''.join(filter(str.isdigit, phone))
    return len(digits) >= 10

if __name__ == "__main__":
    print(f"Phone valid: {validate_phone('+1-555-123-4567')}")
```
5. Verify the structure was created correctly:
```
â”œâ”€â”€ data-processing
â”‚   â””â”€â”€ process_sales.py
â”œâ”€â”€ dev.testing
â”‚   â””â”€â”€ files
â”‚       â””â”€â”€ process_orders.py
â””â”€â”€ common
    â””â”€â”€ files
        â””â”€â”€ validator.py 
```

![Required folder structure.](/images/kestra-git-demo-folder-structure.png)

7. Connect Your Local Repository to GitHub:
Replace YOUR-USERNAME with your actual GitHub username:
```bash
git remote add origin https://github.com/YOUR-USERNAME/kestra-demo.git
```
Verify the remote was added:
```bash
git remote -v
```

You should see:
```bash
origin  https://github.com/YOUR-USERNAME/kestra-demo.git (fetch)
origin  https://github.com/YOUR-USERNAME/kestra-demo.git (push)
```
7. Add, commit, and push your files to GitHub:
```bash
git add .
git commit -m "Initial commit: Add data processing and shared utilities"
git branch -M main
git push -u origin main
```
> [!NOTE]
> If this is your first time pushing to this repository, you may need to authenticate with GitHub. Follow the prompts or use a personal access token if password authentication is disabled.

### Step 3: Create a GitHub Personal Access Token
Kestra needs authentication to access your repository.

> [!NOTE]
> The following access token is just an example. Make sure to properly configure your tokens for your use case and to be compliant with your companies' requirements.

1. In GitHub, click your profile picture â†’ `Settings`
1. Scroll down and click `Developer settings` (bottom left)
1. Click `Personal access tokens` â†’ `Tokens (classic)`
1. Click `Generate new token` â†’ `Generate new token (classic)`
![New personal access token page in GitHub.](/images/pat-github.png)
1. Configure your token:
Note: "Kestra Demo Access"
Expiration: 30 days (or as needed)
Scopes: Check `repo` (Full control of private repositories)
1. Click `Generate token` at the bottom
1. Important: Copy the token immediately (it starts with ghp_). You won't be able to see it again!

### Step 4: Store GitHub Token and User Credentials in Your Config
> [!NOTE]
> If you have the enterprise edition, you can also store the token in the secrets of the namespace which simplifies this step (`Namespace` -> select your namespace -> `Secrets`).

If you use the open-source option, do the following:

> [!CAUTION]
> Make sure to put the `.env` and `.env_encoded` files into your `.gitignore` file.

1. Create an environment file (`.env`) with this content:
```
GITHUB_TOKEN=[YOUR_GITHUB_PERSONAL_ACCESS_TOKEN]
KESTRA_USER=[YOUR_KESTRA_USER]
KESTRA_PASSWORD=[YOUR_KESTRA_PASSWORD]
```
2. Use the encode_secrets.sh file to create a base64 encoded secrets file.
You should see an `.env_encoded` file which contains the base64 encoded secret.

3. Create a Kubernetes Secret from your `.env_encoded` file with this command:
```bash
kubectl create secret generic kestra-secrets --from-env-file=.env_encoded
```
4. Verify it was created by running:
```bash
kubectl describe secret kestra-secrets
```
5. Update your `config.yml` to reference this Kubernetes Secret by adding this entry in the common section (on the same level as `extraEnv` before):
```yaml
  extraEnvFrom:
    - secretRef:
        name: kestra-secrets
```

ðŸ‘‰ More info about [secrets in the open source version](https://kestra.io/docs/concepts/secret#secrets-in-the-open-source-version).

### Step 5: Upgrade Kestra
Run this (or uninstall and recreate Kestra as described before):
```bash
helm upgrade kestra kestra/kestra -f config_github.yml

kubectl get pods -l app.kubernetes.io/name=kestra -w
```
Wait for `2/2 Running`.

### Set Up NamespaceSync (Project-Specific Code)
Let's sync the data-processing folder to a specific namespace.

In Kestra UI, create this new flow:
```yaml
id: sync-project-code
namespace: dev.testing

tasks:
  - id: sync_code
    type: io.kestra.plugin.git.SyncNamespaceFiles
    gitDirectory: data-processing
    namespace: dev.testing
    url: https://github.com/YOUR-USERNAME/kestra-demo.git
    branch: main
    username: YOUR-USERNAME
    password: "{{ secret('GITHUB_TOKEN') }}"
    
triggers:
  - id: sync_schedule
    type: io.kestra.plugin.core.trigger.Schedule
    cron: "*/15 * * * *"  # Sync every 15 minutes
```

> [!IMPORTANT]
> Replace `YOUR-USERNAME` with your actual GitHub username.

This will sync the code with GitHub every 15 minutes.

Lastly, click **Save** and **Execute** to run the sync immediately.

#### Check if the file was synced

If there were no errors, go to your namespace and check the `Files` menu. You should see the synced files (see screenshot below):

![Synced namespace files](/images/synced-namespace-files.png)

Now the file can be used in other flows.

#### Update Your Code

Do a small change to `process_sales.py` like adding an additional print-statement. Commit and push the changes and wait for 15 minutes or manually trigger the flow and the file stored in the namespace should also be updated.

ðŸ‘‰ More info about [NamespaceSync](https://kestra.io/plugins/plugin-git/io.kestra.plugin.git.namespacesync).


### Show that the deletion of files also works 

Add this line below the password in the flow's task. It'll remove everything else from the namespace :D
``` delete: true ```

### Set up TenantSync
TenantSync synchronizes files and flows across ALL namespaces in your tenant. Unlike NamespaceSync, it requires API authentication and expects a specific folder structure.

#### Understanding the Structure

TenantSync expects your Git repository to follow this pattern:
```
<namespace>/
  â”œâ”€â”€ flows/        # Flow YAML definitions (optional)
  â””â”€â”€ files/        # Namespace files (scripts, configs)
```  

We've already created this structure:
- `dev.testing/files/process_orders.py` - Project-specific file
- `common/files/validator.py` - Shared utility

#### Create the TenantSync Flow
In Kestra UI, create a new flow in the `system` namespace:

```yaml
id: sync-tenant-code
namespace: system

tasks:
  - id: sync_tenant
    type: io.kestra.plugin.git.TenantSync
    sourceOfTruth: GIT
    whenMissingInSource: KEEP
    url: https://github.com/YOUR-USERNAME/kestra-git-demo.git
    branch: main
    username: YOUR-USERNAME
    password: "{{ secret('GITHUB_TOKEN') }}"
    kestraUrl: "http://localhost:8080"
    auth:
      username: "{{ secret('KESTRA_USER') }}"
      password: "{{ secret('KESTRA_PASSWORD') }}"
    
triggers:
  - id: sync_schedule
    type: io.kestra.plugin.core.trigger.Schedule
    cron: "*/15 * * * *"
```

> [!IMPORTANT]
> - Replace YOUR-USERNAME with your actual GitHub username.
> - The kestraUrl uses localhost because the task runs inside the Kubernetes cluster.

> [!IMPORTANT]
> You need to have the listed namespaces of your GitHub repo (dev.testing, common, data-processing). If you use the Open Source edition, you cannot create them via Kestra UI. However, you can run a simple flow (see Run Python Code) with the required namespace and this will generate the namespace for you.

Click "Execute".

If there were no errors, go to your namespace and check the `Files` menu. You should see the synced files (see screenshot below):

![Synced namespace files](/images/synced-tenantsync-files.png)

Now the file can be used in other flows and synced when changes happen.

ðŸ‘‰ More info about [TenantSync](https://kestra.io/plugins/plugin-git/io.kestra.plugin.git.tenantsync).
